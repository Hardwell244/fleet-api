# üõ°Ô∏è Documenta√ß√£o de Seguran√ßa - Fleet API

## Vis√£o Geral

Esta API implementa m√∫ltiplas camadas de seguran√ßa seguindo as melhores pr√°ticas da ind√∫stria. Este documento detalha todas as medidas de seguran√ßa implementadas.

---

## 1. Autentica√ß√£o e Autoriza√ß√£o

### 1.1 Laravel Sanctum
- **Token-based authentication** para APIs
- Tokens gerados com hash SHA-256
- Tokens armazenados de forma segura no banco de dados
- Expira√ß√£o configur√°vel de tokens

### 1.2 Policies (Authorization)
Implementadas policies para todos os recursos principais:

- `VehiclePolicy` - Controla acesso a ve√≠culos
- `DriverPolicy` - Controla acesso a motoristas
- `MaintenancePolicy` - Controla acesso a manuten√ß√µes
- `DeliveryPolicy` - Controla acesso a entregas

**Cada policy verifica:**
- Usu√°rio pertence √† mesma empresa (company_id)
- Permiss√µes espec√≠ficas (view, create, update, delete)

**Exemplo de uso no controller:**
```php
$this->authorize('view', $vehicle);
$this->authorize('update', $driver);
$this->authorize('delete', $delivery);
```

---

## 2. Multi-Tenancy (Isolamento de Dados)

### 2.1 Company ID
- Todas as tabelas principais possuem `company_id`
- Trait `BelongsToCompany` aplicada em todos os models
- Policies garantem que usu√°rios s√≥ acessam dados da pr√≥pria empresa

### 2.2 Valida√ß√£o Autom√°tica
- Middleware `EnsureCompanyOwnership` (dispon√≠vel mas opcional)
- Policies verificam company_id em TODAS opera√ß√µes
- Imposs√≠vel acessar dados de outras empresas

**Teste de Seguran√ßa:**
```bash
# Usu√°rio da Company 1 tentando acessar ve√≠culo da Company 2
GET /api/v1/vehicles/999
# Retorna: 403 Forbidden (This action is unauthorized)
```

---

## 3. Rate Limiting (Prote√ß√£o contra DDoS/Brute Force)

### 3.1 Limitadores Configurados

**Login:**
```php
RateLimiter::for('login', function (Request $request) {
    return Limit::perMinute(5)->by($request->ip());
});
```
- M√°ximo 5 tentativas de login por minuto por IP
- Previne ataques de for√ßa bruta

**API Geral:**
```php
RateLimiter::for('api', function (Request $request) {
    return Limit::perMinute(60)->by($request->user()?->id ?: $request->ip());
});
```
- M√°ximo 60 requisi√ß√µes por minuto por usu√°rio/IP
- Previne abuso da API

**Rastreamento P√∫blico:**
```php
RateLimiter::for('tracking', function (Request $request) {
    return Limit::perMinute(10)->by($request->ip());
});
```
- M√°ximo 10 consultas por minuto por IP
- Previne scraping de dados de rastreamento

### 3.2 Aplica√ß√£o nas Rotas
```php
// Login com rate limit
Route::prefix('auth')->middleware('throttle:login')->group(function () {
    Route::post('/login', [AuthController::class, 'login']);
});

// API protegida com rate limit
Route::middleware(['auth:sanctum', 'throttle:api'])->group(function () {
    // Rotas protegidas
});

// Rastreamento p√∫blico com rate limit
Route::middleware('throttle:tracking')->group(function () {
    Route::get('/v1/deliveries/track/{code}', [DeliveryController::class, 'track']);
});
```

---

## 4. CORS (Cross-Origin Resource Sharing)

### 4.1 Configura√ß√£o Segura
Arquivo: `config/cors.php`
```php
'allowed_origins' => [
    'http://localhost:3000',           // Next.js dev
    'http://localhost:3001',           // Backup dev
    'https://fleet.seudominio.com',    // Produ√ß√£o
],
'supports_credentials' => true,
```

**Prote√ß√µes:**
- Lista branca de origens permitidas
- Bloqueia requisi√ß√µes de dom√≠nios n√£o autorizados
- Suporta credenciais (cookies, tokens)

### 4.2 Atualiza√ß√£o para Produ√ß√£o
‚ö†Ô∏è **IMPORTANTE:** Antes de deploy, atualizar `allowed_origins` com o dom√≠nio de produ√ß√£o!

---

## 5. Auditoria e Logs

### 5.1 Trait LogsActivity
Aplicada em todos os models principais (Vehicle, Driver, Maintenance, Delivery)

**Registra automaticamente:**
- **CREATE:** Quem criou, quando, IP, dados completos
- **UPDATE:** Quem atualizou, quando, IP, mudan√ßas (antes/depois)
- **DELETE:** Quem deletou, quando, IP, dados do registro

**Exemplo de log:**
```json
{
  "model": "Vehicle",
  "id": 123,
  "company_id": 1,
  "user_id": 5,
  "user_email": "admin@empresa.com",
  "ip": "192.168.1.100",
  "changes": {
    "status": "available -> in_use",
    "current_km": "10000 -> 10500"
  }
}
```

### 5.2 Canal de Log Dedicado
Arquivo: `storage/logs/audit.log`
- Logs separados da aplica√ß√£o principal
- Rota√ß√£o di√°ria
- Reten√ß√£o de 90 dias
- Permiss√µes restritas (0664)

### 5.3 Auditoria em Tempo Real
Logs acess√≠veis via:
```bash
tail -f storage/logs/audit.log
```

---

## 6. Prote√ß√£o contra Vulnerabilidades Comuns

### 6.1 SQL Injection
‚úÖ **PROTEGIDO** - Eloquent ORM com prepared statements
- Nunca usamos queries raw sem binding
- Todos os par√¢metros s√£o escapados automaticamente

**Exemplo seguro:**
```php
Vehicle::where('plate', $plate)->first();  // ‚úÖ Seguro
Vehicle::whereRaw("plate = ?", [$plate]); // ‚úÖ Seguro com binding
```

### 6.2 XSS (Cross-Site Scripting)
‚úÖ **PROTEGIDO** - API retorna apenas JSON
- Sem renderiza√ß√£o de HTML
- Headers `Content-Type: application/json`
- Blade escaping autom√°tico (se usado)

### 6.3 CSRF (Cross-Site Request Forgery)
‚ö†Ô∏è **N√ÉO APLIC√ÅVEL** - API Stateless
- APIs baseadas em token n√£o precisam de CSRF
- Sanctum usa tokens Bearer no header Authorization

### 6.4 Mass Assignment
‚úÖ **PROTEGIDO** - Models com $fillable definido
```php
protected $fillable = [
    'plate', 'brand', 'model', // Lista branca de campos
];
```
- Apenas campos listados podem ser preenchidos em massa
- Previne modifica√ß√£o de campos sens√≠veis (id, created_at, etc)

---

## 7. Valida√ß√£o de Dados

### 7.1 Form Requests
Valida√ß√µes centralizadas em classes dedicadas:
- `StoreVehicleRequest`
- `UpdateVehicleRequest`
- `StoreDriverRequest`
- Etc...

**Benef√≠cios:**
- Valida√ß√µes executadas ANTES do controller
- Mensagens de erro padronizadas
- C√≥digo limpo e organizado

**Exemplo:**
```php
public function rules(): array
{
    return [
        'plate' => 'required|string|max:10|unique:vehicles,plate',
        'year' => 'required|integer|min:1900|max:' . (date('Y') + 1),
        'fuel_capacity' => 'nullable|numeric|min:0|max:999.99',
    ];
}
```

### 7.2 DTOs (Data Transfer Objects)
Camada adicional de type safety:
```php
readonly class VehicleDTO
{
    public function __construct(
        public readonly int $company_id,
        public readonly string $plate,
        // ...
    ) {}
}
```

---

## 8. Boas Pr√°ticas Implementadas

### 8.1 Soft Deletes
- Dados nunca s√£o deletados fisicamente
- Possibilidade de recupera√ß√£o
- Auditoria completa de exclus√µes

### 8.2 Eager Loading
- Previne N+1 queries
- Melhor performance
```php
Vehicle::with('company')->get(); // ‚úÖ Otimizado
```

### 8.3 Repository Pattern
- Separa√ß√£o de responsabilidades
- Facilita testes unit√°rios
- C√≥digo reutiliz√°vel

### 8.4 Service Layer
- L√≥gica de neg√≥cio centralizada
- Controllers finos e limpos
- Facilita manuten√ß√£o

---

## 9. Avisos Importantes

### 9.1 Senhas em Seeders
‚ö†Ô∏è **APENAS PARA DESENVOLVIMENTO**

Os seeders usam senhas em plain text:
```php
'password' => bcrypt('password'), // Senha: "password"
```

**‚ö†Ô∏è EM PRODU√á√ÉO:**
- Nunca usar seeders com senhas padr√£o
- Gerar senhas fortes aleatoriamente
- For√ßar troca de senha no primeiro login

### 9.2 Vari√°veis de Ambiente
‚ö†Ô∏è **NUNCA COMMITAR `.env`**
- Arquivo `.env` cont√©m credenciais sens√≠veis
- Sempre usar `.env.example` como template
- Usar senhas fortes em produ√ß√£o

---

## 10. Recursos N√ÉO Implementados (Opcional)

### 10.1 2FA (Two-Factor Authentication)
N√£o implementado nesta vers√£o. Para adicionar:
- Laravel Fortify
- Google Authenticator
- SMS/Email OTP

### 10.2 Criptografia de Campos Sens√≠veis
Campos como CPF/CNH n√£o est√£o criptografados.

**Para implementar:**
```php
protected $casts = [
    'cpf' => 'encrypted',
    'cnh' => 'encrypted',
];
```

‚ö†Ô∏è **Aten√ß√£o:** Criptografia impede buscas exatas. Considerar hash para busca + criptografia para exibi√ß√£o.

### 10.3 IP Whitelist
N√£o implementado. Para ambientes cr√≠ticos, considere:
- Firewall em n√≠vel de servidor
- Middleware de IP whitelist
- VPN obrigat√≥ria

---

## 11. Checklist de Deploy em Produ√ß√£o

Antes de fazer deploy, verificar:

- [ ] Atualizar `allowed_origins` no CORS
- [ ] Gerar APP_KEY nova: `php artisan key:generate`
- [ ] Configurar vari√°veis de ambiente (.env)
- [ ] Remover/desabilitar seeders
- [ ] Configurar HTTPS obrigat√≥rio
- [ ] Configurar backup autom√°tico do banco
- [ ] Ativar logs de erros (Sentry, Bugsnag, etc)
- [ ] Configurar rate limits adequados
- [ ] Revisar permiss√µes de arquivos (storage, bootstrap/cache)
- [ ] Configurar queue workers (opcional)
- [ ] Configurar cron jobs (opcional)

---

## 12. Contato de Seguran√ßa

Se encontrar uma vulnerabilidade de seguran√ßa, por favor reporte para:
- Email: security@seudominio.com
- N√£o divulgue publicamente at√© corre√ß√£o

---

## 13. Refer√™ncias

- [Laravel Security Best Practices](https://laravel.com/docs/11.x/security)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Laravel Sanctum Docs](https://laravel.com/docs/11.x/sanctum)
- [Laravel Policies](https://laravel.com/docs/11.x/authorization)

---

**√öltima atualiza√ß√£o:** Janeiro 2026
**Vers√£o:** 1.0.0
